const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConfirmDialog-wgQ6Hnee.js","assets/query-vendor-CVtgHnZ_.js","assets/react-vendor-31zzwpBM.js","assets/radix-vendor-hfgbE2XR.js","assets/index-DKQd0WCU.js","assets/utils-vendor-B_WdigmM.js","assets/index-_u7sPNxg.css","assets/useToast-D9XOOVtq.js"])))=>i.map(i=>d[i]);
import{a as e,A as a,_ as t}from"./index-DKQd0WCU.js";import{j as s,u as r,d as n,c as i}from"./query-vendor-CVtgHnZ_.js";import{r as l,u as o,i as c,L as m}from"./react-vendor-31zzwpBM.js";import{h as d,I as u,F as x,l as p,m as h,O as j,n as f,o as g,p as b}from"./radix-vendor-hfgbE2XR.js";import{B as v,f as y,O as C,u as N,L as E,E as w,a as q,b as I}from"./useToast-D9XOOVtq.js";import{u as S,F as k,I as O,T as P}from"./Textarea-C6yzHASN.js";import"./utils-vendor-B_WdigmM.js";function L({onSubmit:e,onCancel:a,placeholder:t="Escribe un comentario...",initialContent:r="",initialName:n="",initialAvatar:i="",isEditMode:o=!1}){const{register:c,handleSubmit:m,formState:{errors:d},reset:u,setValue:x}=S({defaultValues:{content:r,name:n,avatar:i}});l.useEffect(()=>{o&&(x("content",r),x("name",n),x("avatar",i))},[o,r,n,i,x]);return s.jsxs("form",{onSubmit:m(a=>{e(a.content.trim(),a.name.trim(),a.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${a.name||"user"}`),o||u()}),className:"space-y-3",noValidate:!0,children:[!o&&s.jsx(k,{error:d.name?.message,children:s.jsx(O,{...c("name",{required:"El nombre es requerido",minLength:{value:2,message:"El nombre debe tener al menos 2 caracteres"}}),className:"text-sm",placeholder:"Tu nombre",error:!!d.name})}),s.jsx(k,{error:d.content?.message,children:s.jsx(P,{...c("content",{required:"El comentario es requerido",minLength:{value:3,message:"El comentario debe tener al menos 3 caracteres"}}),className:"text-sm",rows:3,placeholder:t,error:!!d.content})}),s.jsxs("div",{className:"flex justify-end gap-2",children:[a&&s.jsx(v,{variant:"secondary",size:"small",type:"button",onClick:a,children:"Cancelar"}),s.jsx(v,{size:"small",type:"submit",children:o?"Guardar":"Comentar"})]})]})}const A=l.memo(function e({comment:a,postId:t,onDelete:r,onReply:n,onEdit:i,depth:o}){const[c,m]=l.useState(!1),[p,h]=l.useState(!0),j=a.replies&&a.replies.length>0,f=o<5,g=y(a.createdAt),b=l.useCallback((e,t,s)=>{n(a.id,e,t,s),m(!1)},[a.id,n]),v=l.useCallback(()=>{m(e=>!e)},[]),N=l.useCallback(()=>{h(e=>!e)},[]),E=l.useCallback(()=>{r(a.id)},[a.id,r]),w=l.useCallback(()=>{i(a)},[a,i]),q=24*o;return s.jsxs("div",{className:"relative",style:{marginLeft:`${q}px`},children:[o>0&&s.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gray-300",style:{left:"-24px"}}),s.jsxs("div",{className:"card mb-4",children:[s.jsxs("div",{className:"flex items-start justify-between gap-4",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[s.jsxs(d,{className:"inline-flex items-center justify-center align-middle overflow-hidden select-none w-8 h-8 rounded-full bg-primary-100 flex-shrink-0",children:[s.jsx(u,{src:a.avatar,alt:a.name,className:"w-full h-full object-cover"}),s.jsx(x,{className:"w-full h-full flex items-center justify-center bg-primary-500 text-white text-xs font-medium",children:a.name.charAt(0).toUpperCase()})]}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:a.name}),s.jsx("p",{className:"text-xs text-gray-500",children:g})]})]}),s.jsx("p",{className:"text-gray-700 whitespace-pre-wrap mb-3",children:a.content}),s.jsxs("div",{className:"flex items-center gap-4",children:[f&&s.jsx("button",{onClick:v,className:"text-sm text-primary-600 hover:text-primary-700 font-medium transition-colors cursor-pointer",children:c?"Cancelar":"Responder"}),j&&s.jsx("button",{onClick:N,className:"text-sm text-gray-600 hover:text-gray-700 font-medium transition-colors cursor-pointer",children:p?`Ocultar ${a.replies.length} respuesta${a.replies.length>1?"s":""}`:`Mostrar ${a.replies.length} respuesta${a.replies.length>1?"s":""}`})]})]}),s.jsx(C,{ariaLabel:"Opciones del comentario",items:[{label:"Editar",onClick:w,variant:"default"},{label:"Eliminar",onClick:E,variant:"danger"}]})]}),c&&f&&s.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:s.jsx(L,{onSubmit:b,onCancel:v,placeholder:"Escribe tu respuesta..."})})]}),j&&p&&s.jsx("div",{className:"mt-2",children:a.replies.map(a=>s.jsx(e,{comment:a,postId:t,onDelete:r,onReply:n,onEdit:i,depth:o+1},a.id))})]})}),D=l.memo(function({comments:e,postId:a,onDelete:t,onReply:r,onEdit:n}){return 0===e.length?s.jsx("div",{className:"text-center py-8 text-gray-500",children:s.jsx("p",{children:"No hay comentarios aún. ¡Sé el primero en comentar!"})}):s.jsx("div",{className:"space-y-4",children:e.map(e=>s.jsx(A,{comment:e,postId:a,onDelete:t,onReply:r,onEdit:n,depth:0},e.id))})});function R({comment:a,isOpen:t,onClose:r,onSubmit:n}){const{register:i,handleSubmit:o,formState:{errors:c},reset:m,setValue:d}=S({defaultValues:{content:"",name:"",avatar:""}});l.useEffect(()=>{a?(d("content",a.content),d("name",a.name),d("avatar",a.avatar)):m()},[a,t,d,m]);const u=!!a;return s.jsx(p,{open:t,onOpenChange:r,children:s.jsxs(h,{children:[s.jsx(j,{className:"fixed inset-0 bg-black/50 z-40"}),s.jsxs(f,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%-2rem)] sm:w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-xl z-50 p-4 sm:p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsx(g,{className:"text-2xl font-bold text-gray-900",children:u?"Editar Comentario":"Nuevo Comentario"}),s.jsx(b,{asChild:!0,children:s.jsx("button",{className:"p-2 rounded-lg hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500","aria-label":"Cerrar",children:s.jsx(e,{className:"w-5 h-5 text-gray-600"})})})]}),s.jsxs("form",{onSubmit:o(e=>{n(e.content.trim(),e.name.trim(),e.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${e.name||"user"}`),a||m()}),className:"space-y-4",noValidate:!0,children:[!u&&s.jsx(k,{label:"Nombre",error:c.name?.message,required:!0,children:s.jsx(O,{...i("name",{required:"El nombre es requerido",minLength:{value:2,message:"El nombre debe tener al menos 2 caracteres"}}),placeholder:"Tu nombre",error:!!c.name})}),!u&&s.jsx(k,{label:"Avatar URL (opcional)",error:c.avatar?.message,children:s.jsx(O,{...i("avatar",{pattern:{value:/^https?:\/\/.+/,message:"Debe ser una URL válida"}}),type:"url",placeholder:"https://ejemplo.com/avatar.jpg",error:!!c.avatar})}),s.jsx(k,{label:"Comentario",error:c.content?.message,required:!0,children:s.jsx(P,{...i("content",{required:"El comentario es requerido",minLength:{value:3,message:"El comentario debe tener al menos 3 caracteres"}}),rows:6,placeholder:"Escribe tu comentario aquí...",error:!!c.content})}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[s.jsx(b,{asChild:!0,children:s.jsx(v,{variant:"secondary",type:"button",children:"Cancelar"})}),s.jsx(v,{type:"submit",children:u?"Guardar Cambios":"Comentar"})]})]})]})]})})}const T=l.lazy(()=>t(()=>import("./ConfirmDialog-wgQ6Hnee.js"),__vite__mapDeps([0,1,2,3,4,5,6,7])).then(e=>({default:e.ConfirmDialog})));function F(){const{postId:e}=o(),t=c(),p=r(),h=N(),[j,f]=l.useState(!1),[g,b]=l.useState({isOpen:!1,commentId:null}),[S,k]=l.useState(!1),[O,P]=l.useState(null),A=l.useRef(!1),{data:F,isLoading:V,error:K}=n({queryKey:["post",e],queryFn:()=>I.getSinglePost(e),enabled:!!e}),{data:$,isLoading:z}=n({queryKey:["comments",e],queryFn:()=>I.getComments(e),enabled:!!e,refetchOnMount:!1,refetchOnWindowFocus:!1});l.useEffect(()=>{K&&!A.current&&(A.current=!0,h.error("Error al cargar el post. Por favor, intenta nuevamente.")),K||(A.current=!1)},[K]);const Q=i({mutationFn:async e=>(await I.deleteAllComments(e),I.deletePost(e)),onSuccess:(e,a)=>{p.invalidateQueries({queryKey:["posts"]}),p.removeQueries({queryKey:["post",a]}),p.removeQueries({queryKey:["comments",a]}),h.success("Post eliminado correctamente"),t("/")},onError:()=>{h.error("Error al eliminar el post. Por favor, intenta nuevamente.")}}),_=i({mutationFn:({content:a,name:t,avatar:s,parentId:r})=>I.createComment(e,{content:a,name:t,avatar:s,parentId:r,createdAt:(new Date).toISOString()}),onSuccess:(a,t)=>{p.invalidateQueries({queryKey:["comments",e]}),t.parentId?h.success("Respuesta creada correctamente"):h.success("Comentario creado correctamente")},onError:()=>{h.error("Error al crear el comentario. Por favor, intenta nuevamente.")}}),M=i({mutationFn:a=>I.deleteCommentRecursive(e,a),onSuccess:()=>{p.invalidateQueries({queryKey:["comments",e]}),h.success("Comentario eliminado correctamente")},onError:()=>{h.error("Error al eliminar el comentario. Por favor, intenta nuevamente.")}}),U=i({mutationFn:({commentId:a,content:t,name:s,avatar:r})=>I.updateComment(e,a,{content:t,name:s,avatar:r}),onSuccess:()=>{p.invalidateQueries({queryKey:["comments",e]}),h.success("Comentario actualizado correctamente")},onError:()=>{h.error("Error al actualizar el comentario. Por favor, intenta nuevamente.")}}),G=l.useCallback(()=>{f(!0)},[]),B=l.useCallback(()=>{e&&Q.mutate(e)},[e,Q]),W=l.useCallback((a,t,s)=>{e&&_.mutate({content:a,name:t,avatar:s,parentId:null})},[e,_]),H=l.useCallback((a,t,s,r)=>{e&&_.mutate({content:t,name:s,avatar:r,parentId:a})},[e,_]),J=l.useCallback(e=>{b({isOpen:!0,commentId:e})},[]),X=l.useCallback(()=>{g.commentId&&M.mutate(g.commentId)},[g.commentId,M]),Y=l.useCallback((e,a,t,s)=>{U.mutate({commentId:e,content:a,name:t,avatar:s}),k(!1),P(null)},[U]),Z=l.useCallback(e=>{P(e),k(!0)},[]),ee=l.useCallback((e,a,t)=>{O&&Y(O.id,e,a,t)},[O,Y]),ae=$?function(e){const a=new Map,t=[];e.forEach(e=>{a.set(e.id,{...e,replies:[]})}),e.forEach(e=>{const s=a.get(e.id);if(null===e.parentId)t.push(s);else{const t=a.get(e.parentId);t&&(t.replies||(t.replies=[]),t.replies.push(s))}});const s=(e,a)=>new Date(a.createdAt).getTime()-new Date(e.createdAt).getTime();t.sort(s);const r=e=>{e.sort(s),e.forEach(e=>{e.replies&&e.replies.length>0&&r(e.replies)})};return r(t),t}($):[],te=F?y(F.createdAt):"";return V?s.jsx(E,{message:"Cargando post..."}):K||!F?s.jsx(w,{message:"Error al cargar el post",action:s.jsx(v,{as:"link",to:"/",children:"Volver a posts"})}):s.jsxs("div",{children:[(Q.isPending||M.isPending||U.isPending||_.isPending)&&s.jsx(q,{message:Q.isPending?"Eliminando post...":M.isPending?"Eliminando comentario...":U.isPending?"Guardando comentario...":"Creando comentario..."}),s.jsxs(m,{to:"/",className:"inline-flex items-center gap-2 text-primary-600 hover:text-primary-700 mb-6 transition-colors",children:[s.jsx(a,{className:"w-5 h-5"}),"Volver a posts"]}),s.jsx("article",{className:"card mb-8",children:s.jsxs("div",{className:"flex items-start justify-between gap-4 mb-6",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:F.title}),s.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[s.jsxs(d,{className:"inline-flex items-center justify-center align-middle overflow-hidden select-none w-10 h-10 rounded-full bg-primary-100",children:[s.jsx(u,{src:F.avatar,alt:F.name,className:"w-full h-full object-cover"}),s.jsx(x,{className:"w-full h-full flex items-center justify-center bg-primary-500 text-white text-sm font-medium",children:F.name.charAt(0).toUpperCase()})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-900",children:F.name}),s.jsx("p",{className:"text-xs text-gray-500",children:te})]})]}),s.jsx("p",{className:"text-gray-700 whitespace-pre-wrap leading-relaxed",children:F.content})]}),s.jsx(C,{ariaLabel:"Opciones del post",items:[{label:"Eliminar",onClick:G,variant:"danger"}]})]})}),s.jsxs("section",{className:"mb-8",children:[s.jsxs("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:["Comentarios ",$&&`(${$.filter(e=>!e.parentId).length})`]}),s.jsx("div",{className:"card mb-6",children:s.jsx(L,{onSubmit:W})})]}),z?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"}),s.jsx("p",{className:"mt-4 text-gray-600",children:"Cargando comentarios..."})]})}):s.jsx(D,{comments:ae,postId:e,onDelete:J,onReply:H,onEdit:Z}),(j||g.isOpen)&&s.jsxs(l.Suspense,{fallback:null,children:[j&&s.jsx(T,{isOpen:j,onClose:()=>f(!1),onConfirm:B,title:"Eliminar Post",description:"¿Estás seguro de que quieres eliminar este post? Esta acción no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"}),g.isOpen&&s.jsx(T,{isOpen:g.isOpen,onClose:()=>b({isOpen:!1,commentId:null}),onConfirm:X,title:"Eliminar Comentario",description:"¿Estás seguro de que quieres eliminar este comentario? Esta acción no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"})]}),S&&s.jsx(R,{comment:O,isOpen:S,onClose:()=>{k(!1),P(null)},onSubmit:ee})]})}export{F as PostDetail};
